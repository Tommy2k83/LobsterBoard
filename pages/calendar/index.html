<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LobsterBoard - Calendar</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #e6edf3; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem 1.5rem; }
    .page-header { display: flex; justify-content: space-between; align-items: center; }
    .page-header h1 { font-size: 1.5rem; }
    .subtitle { color: #8b949e; font-size: 0.85rem; }

    /* Nav bar */
    .cal-nav { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .cal-nav button { background: transparent; color: #8b949e; border: 1px solid #30363d; border-radius: 6px; padding: 6px 14px; font-size: 13px; cursor: pointer; }
    .cal-nav button:hover { background: #161b22; color: #e6edf3; }
    .cal-nav button.active { background: #58a6ff; color: #0d1117; border-color: #58a6ff; font-weight: 600; }
    .cal-nav .nav-title { font-size: 1.1rem; font-weight: 600; min-width: 200px; text-align: center; }
    .cal-nav .spacer { flex: 1; }

    .cal-layout { display: flex; gap: 1rem; margin-top: 1rem; }
    .cal-main { flex: 1; min-width: 0; }
    .cal-sidebar { width: 260px; min-width: 260px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1rem; align-self: flex-start; position: sticky; top: 1rem; }

    /* Month grid */
    .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #30363d; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; }
    .month-header { background: #161b22; padding: 8px; text-align: center; font-size: 11px; text-transform: uppercase; color: #8b949e; font-weight: 600; }
    .month-cell { background: #0d1117; padding: 6px; min-height: 100px; cursor: pointer; transition: background 0.15s; position: relative; }
    .month-cell:hover { background: #161b22; }
    .month-cell.other-month { opacity: 0.4; }
    .month-cell.today { background: #161b22; box-shadow: inset 0 0 0 2px #58a6ff; }
    .month-cell .day-num { font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #8b949e; }
    .month-cell.today .day-num { color: #58a6ff; }
    .ev-chip { font-size: 11px; padding: 1px 4px; margin-bottom: 2px; border-radius: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; border-left: 3px solid; }
    .ev-chip.all-day { background: rgba(88,166,255,0.15); border-left: none; border-radius: 3px; text-align: center; font-weight: 500; }
    .ev-chip.cron-event { background: rgba(240,136,62,0.15); border-color: #f0883e; font-style: italic; }
    .ev-more { font-size: 10px; color: #8b949e; margin-top: 2px; }

    /* Week view */
    .week-grid { display: grid; grid-template-columns: 50px repeat(7, 1fr); border: 1px solid #30363d; border-radius: 8px; overflow: hidden; }
    .week-header { background: #161b22; padding: 8px 4px; text-align: center; font-size: 11px; color: #8b949e; border-bottom: 1px solid #30363d; }
    .week-header.today { color: #58a6ff; font-weight: 700; }
    .week-time-col { background: #0d1117; }
    .week-time-label { height: 60px; padding: 2px 6px; font-size: 10px; color: #8b949e; text-align: right; border-bottom: 1px solid #21262d; }
    .week-day-col { position: relative; background: #0d1117; }
    .week-slot { height: 60px; border-bottom: 1px solid #21262d; border-left: 1px solid #21262d; }
    .week-event { position: absolute; left: 2px; right: 2px; border-radius: 4px; padding: 2px 4px; font-size: 11px; overflow: hidden; cursor: pointer; z-index: 1; border-left: 3px solid; }

    /* Agenda view */
    .agenda-group { margin-bottom: 1.25rem; }
    .agenda-date { font-size: 13px; font-weight: 600; color: #8b949e; padding: 6px 0; border-bottom: 1px solid #21262d; margin-bottom: 6px; }
    .agenda-date.today { color: #58a6ff; }
    .agenda-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 10px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
    .agenda-item:hover { background: #161b22; }
    .agenda-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
    .agenda-time { font-size: 12px; color: #8b949e; min-width: 90px; }
    .agenda-title { font-size: 13px; }

    /* Sidebar */
    .sidebar-section { margin-bottom: 1rem; }
    .sidebar-section h3 { font-size: 11px; text-transform: uppercase; color: #8b949e; margin-bottom: 0.5rem; letter-spacing: 0.5px; }
    .source-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 6px; font-size: 13px; cursor: pointer; }
    .source-item:hover { background: #21262d; }
    .source-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .source-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .source-toggle { appearance: none; width: 32px; height: 18px; background: #30363d; border-radius: 9px; position: relative; cursor: pointer; border: none; transition: background 0.2s; flex-shrink: 0; }
    .source-toggle::after { content: ''; position: absolute; width: 14px; height: 14px; border-radius: 50%; background: #8b949e; top: 2px; left: 2px; transition: all 0.2s; }
    .source-toggle:checked { background: #58a6ff; }
    .source-toggle:checked::after { left: 16px; background: #fff; }
    .source-actions { display: flex; gap: 4px; }
    .source-actions button { background: none; border: none; color: #8b949e; cursor: pointer; font-size: 12px; padding: 2px; }
    .source-actions button:hover { color: #e6edf3; }

    .btn-primary { background: #58a6ff; color: #0d1117; border: none; border-radius: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; width: 100%; }
    .btn-primary:hover { background: #79b8ff; }
    .btn-sm { padding: 5px 10px; font-size: 12px; width: auto; }
    .btn-danger { background: none; color: #f85149; border: 1px solid #f8514933; border-radius: 6px; padding: 5px 10px; font-size: 12px; cursor: pointer; }
    .btn-danger:hover { background: #f8514922; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 1.5rem; width: 400px; max-width: 90vw; }
    .modal h2 { font-size: 1rem; margin-bottom: 1rem; }
    .modal label { display: block; font-size: 12px; color: #8b949e; margin: 0.75rem 0 0.25rem; }
    .modal input, .modal select { width: 100%; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 8px 10px; color: #e6edf3; font-size: 13px; outline: none; }
    .modal input:focus, .modal select:focus { border-color: #58a6ff; }
    .modal input[type="color"] { padding: 2px; height: 36px; cursor: pointer; }
    .modal-actions { display: flex; gap: 8px; margin-top: 1.25rem; justify-content: flex-end; }

    /* Popover */
    .popover { display: none; position: fixed; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1rem; z-index: 50; width: 300px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .popover.open { display: block; }
    .popover h3 { font-size: 14px; margin-bottom: 6px; }
    .popover .pop-meta { font-size: 12px; color: #8b949e; margin-bottom: 4px; }
    .popover .pop-desc { font-size: 12px; color: #8b949e; margin-top: 8px; white-space: pre-wrap; max-height: 120px; overflow-y: auto; }
    .popover .pop-close { position: absolute; top: 8px; right: 10px; background: none; border: none; color: #8b949e; cursor: pointer; font-size: 16px; }

    .spinner { display: none; text-align: center; padding: 3rem; color: #8b949e; }
    .spinner.active { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner::before { content: ''; display: inline-block; width: 24px; height: 24px; border: 2px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 8px; }
  </style>
</head>
<body>
  <script src="/pages/_shared/nav.js"></script>
  <div class="container">
    <div class="page-header">
      <div><h1>üìÖ Calendar</h1><div class="subtitle">Events from all your sources</div></div>
    </div>

    <div class="cal-nav">
      <button id="btn-prev">‚Üê</button>
      <button id="btn-today">Today</button>
      <button id="btn-next">‚Üí</button>
      <div class="nav-title" id="nav-title"></div>
      <div class="spacer"></div>
      <button class="view-btn active" data-view="month">Month</button>
      <button class="view-btn" data-view="week">Week</button>
      <button class="view-btn" data-view="agenda">Agenda</button>
      <div style="display:flex;align-items:center;gap:6px;margin-left:12px">
        <input type="checkbox" class="source-toggle" id="cron-toggle" title="Show Cron Jobs">
        <label for="cron-toggle" style="font-size:13px;color:#f0883e;cursor:pointer;user-select:none">‚è∞ Cron Jobs</label>
      </div>
    </div>

    <div class="cal-layout">
      <div class="cal-main">
        <div class="spinner" id="spinner">Loading‚Ä¶</div>
        <div id="cal-view"></div>
      </div>
      <div class="cal-sidebar">
        <div class="sidebar-section">
          <h3>Sources</h3>
          <div id="sources-list"></div>
          <button class="btn-primary" style="margin-top:0.75rem" onclick="openAddSource()">+ Add Source</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Source Modal -->
  <div class="modal-overlay" id="source-modal">
    <div class="modal">
      <h2 id="modal-title">Add Source</h2>
      <input type="hidden" id="src-edit-id">
      <label>Name</label><input id="src-name" placeholder="My Calendar">
      <label>Type</label>
      <select id="src-type"><option value="ical">iCal URL</option><option value="cron">Cron Jobs</option></select>
      <label id="lbl-url">URL</label><input id="src-url" placeholder="https://...">
      <label>Color</label><input type="color" id="src-color" value="#58a6ff">
      <div class="modal-actions">
        <button class="btn-danger" id="modal-delete" style="display:none" onclick="deleteSource()">Delete</button>
        <div style="flex:1"></div>
        <button class="btn-primary btn-sm" style="background:transparent;color:#8b949e;border:1px solid #30363d" onclick="closeModal()">Cancel</button>
        <button class="btn-primary btn-sm" onclick="saveSource()">Save</button>
      </div>
    </div>
  </div>

  <!-- Event Popover -->
  <div class="popover" id="popover">
    <button class="pop-close" onclick="closePopover()">√ó</button>
    <h3 id="pop-title"></h3>
    <div class="pop-meta" id="pop-time"></div>
    <div class="pop-meta" id="pop-source"></div>
    <div class="pop-meta" id="pop-location"></div>
    <div class="pop-desc" id="pop-desc"></div>
  </div>

  <script>
    const API = '/pages/calendar/api';
    let currentView = 'month';
    let viewDate = new Date();
    let sources = [];
    let events = [];
    let loading = false;
    let showCron = localStorage.getItem('cal-show-cron') !== 'false'; // default on

    // --- API helpers ---
    async function api(method, path, body) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const r = await fetch(API + path, opts);
      return r.json();
    }

    // --- Cron toggle ---
    const cronToggle = document.getElementById('cron-toggle');
    cronToggle.checked = showCron;
    cronToggle.onchange = () => {
      showCron = cronToggle.checked;
      localStorage.setItem('cal-show-cron', showCron);
      render();
    };

    function filteredEvents() {
      return showCron ? events : events.filter(e => e.source !== 'Cron Jobs');
    }

    // --- Init ---
    async function init() {
      sources = await api('GET', '/sources');
      await loadEvents();
    }

    async function loadEvents() {
      const { start, end } = getViewRange();
      loading = true;
      document.getElementById('spinner').classList.add('active');
      events = await api('GET', `/events?start=${start.toISOString()}&end=${end.toISOString()}`);
      loading = false;
      document.getElementById('spinner').classList.remove('active');
      render();
    }

    function getViewRange() {
      const y = viewDate.getFullYear(), m = viewDate.getMonth(), d = viewDate.getDate();
      if (currentView === 'month') {
        const first = new Date(y, m, 1);
        const start = new Date(first); start.setDate(1 - first.getDay());
        const last = new Date(y, m + 1, 0);
        const end = new Date(last); end.setDate(last.getDate() + (6 - last.getDay()));
        end.setHours(23, 59, 59);
        return { start, end };
      } else if (currentView === 'week') {
        const dow = viewDate.getDay();
        const start = new Date(y, m, d - dow);
        const end = new Date(y, m, d - dow + 6, 23, 59, 59);
        return { start, end };
      } else {
        const start = new Date(y, m, d);
        const end = new Date(y, m, d + 14, 23, 59, 59);
        return { start, end };
      }
    }

    // --- Render ---
    function render() {
      updateTitle();
      renderSources();
      if (currentView === 'month') renderMonth();
      else if (currentView === 'week') renderWeek();
      else renderAgenda();
    }

    function updateTitle() {
      const t = document.getElementById('nav-title');
      if (currentView === 'agenda') { t.textContent = 'Upcoming 14 Days'; return; }
      const opts = currentView === 'week'
        ? { month: 'long', day: 'numeric', year: 'numeric' }
        : { month: 'long', year: 'numeric' };
      t.textContent = viewDate.toLocaleDateString('en-US', opts);
    }

    function renderSources() {
      const el = document.getElementById('sources-list');
      let html = `<div class="source-item"><div class="source-dot" style="background:#f0883e"></div><span class="source-name">‚è∞ Cron Jobs</span><input type="checkbox" class="source-toggle" ${showCron ? 'checked' : ''} onchange="cronToggle.checked=this.checked;cronToggle.onchange()"></div>`;
      for (const s of sources) {
        html += `<div class="source-item">
          <div class="source-dot" style="background:${s.color}"></div>
          <span class="source-name">${esc(s.name)}</span>
          <input type="checkbox" class="source-toggle" ${s.enabled ? 'checked' : ''} onchange="toggleSource('${s.id}', this.checked)">
          <div class="source-actions"><button onclick="editSource('${s.id}')">‚úèÔ∏è</button></div>
        </div>`;
      }
      el.innerHTML = html;
    }

    const today = new Date();
    const todayStr = today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');

    function dayKey(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }

    function renderMonth() {
      const el = document.getElementById('cal-view');
      const y = viewDate.getFullYear(), m = viewDate.getMonth();
      const first = new Date(y, m, 1);
      const startOff = first.getDay();
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const prevDays = new Date(y, m, 0).getDate();

      // Group events by day
      const byDay = {};
      for (const ev of events) {
        const dk = dayKey(new Date(ev.start));
        (byDay[dk] = byDay[dk] || []).push(ev);
      }

      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      let html = '<div class="month-grid">';
      days.forEach(d => { html += `<div class="month-header">${d}</div>`; });

      // Previous month fill
      for (let i = startOff - 1; i >= 0; i--) {
        const dn = prevDays - i;
        const dk = dayKey(new Date(y, m - 1, dn));
        html += renderDayCell(dn, dk, true);
      }
      // Current month
      for (let d = 1; d <= daysInMonth; d++) {
        const dk = dayKey(new Date(y, m, d));
        html += renderDayCell(d, dk, false);
      }
      // Next month fill
      const total = startOff + daysInMonth;
      const remaining = (7 - total % 7) % 7;
      for (let d = 1; d <= remaining; d++) {
        const dk = dayKey(new Date(y, m + 1, d));
        html += renderDayCell(d, dk, true);
      }
      html += '</div>';
      el.innerHTML = html;
    }

    function renderDayCell(dayNum, dk, otherMonth) {
      const isToday = dk === todayStr;
      const cls = `month-cell${otherMonth ? ' other-month' : ''}${isToday ? ' today' : ''}`;
      const dayEvents = (filteredEvents() || []).filter(ev => dayKey(new Date(ev.start)) === dk);
      const MAX = 3;
      let chips = '';
      const allDay = dayEvents.filter(e => e.allDay);
      const timed = dayEvents.filter(e => !e.allDay);
      const sorted = [...allDay, ...timed];
      sorted.slice(0, MAX).forEach(ev => {
        const t = ev.allDay ? '' : new Date(ev.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + ' ';
        const cls2 = ev.allDay ? 'ev-chip all-day' : (ev.source === 'Cron Jobs' ? 'ev-chip cron-event' : 'ev-chip');
        chips += `<div class="${cls2}" style="border-color:${ev.color};background:${ev.allDay ? ev.color + '22' : 'transparent'};color:${ev.allDay ? ev.color : '#e6edf3'}" onclick="showPopover(event, ${JSON.stringify(ev).replace(/"/g, '&quot;')})" title="${esc(ev.title)}">${t}${esc(ev.title)}</div>`;
      });
      if (sorted.length > MAX) chips += `<div class="ev-more">+${sorted.length - MAX} more</div>`;
      return `<div class="${cls}"><div class="day-num">${dayNum}</div>${chips}</div>`;
    }

    function renderWeek() {
      const el = document.getElementById('cal-view');
      const y = viewDate.getFullYear(), m = viewDate.getMonth(), d = viewDate.getDate();
      const dow = viewDate.getDay();
      const weekStart = new Date(y, m, d - dow);

      const days = [];
      for (let i = 0; i < 7; i++) { const dd = new Date(weekStart); dd.setDate(dd.getDate() + i); days.push(dd); }

      const startHour = 6, endHour = 22, totalSlots = endHour - startHour;
      let html = '<div class="week-grid">';
      // Headers
      html += '<div class="week-header"></div>';
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      days.forEach((dd, i) => {
        const isT = dayKey(dd) === todayStr;
        html += `<div class="week-header${isT ? ' today' : ''}">${dayNames[i]} ${dd.getDate()}</div>`;
      });

      // Time column + day columns
      html += '<div class="week-time-col">';
      for (let h = startHour; h < endHour; h++) {
        html += `<div class="week-time-label">${h === 0 ? '12 AM' : h < 12 ? h + ' AM' : h === 12 ? '12 PM' : (h-12) + ' PM'}</div>`;
      }
      html += '</div>';

      days.forEach(dd => {
        const dk = dayKey(dd);
        const dayEvs = filteredEvents().filter(ev => !ev.allDay && dayKey(new Date(ev.start)) === dk);
        html += '<div class="week-day-col">';
        for (let h = startHour; h < endHour; h++) { html += '<div class="week-slot"></div>'; }
        // Position events
        dayEvs.forEach(ev => {
          const st = new Date(ev.start);
          const en = new Date(ev.end);
          const topH = st.getHours() + st.getMinutes()/60 - startHour;
          const durH = Math.max((en - st)/3600000, 0.25);
          const top = Math.max(topH * 60, 0);
          const height = Math.min(durH * 60, totalSlots * 60 - top);
          if (top >= totalSlots * 60) return;
          html += `<div class="week-event" style="top:${top}px;height:${Math.max(height,16)}px;background:${ev.color}22;border-color:${ev.color}" onclick="showPopover(event, ${JSON.stringify(ev).replace(/"/g, '&quot;')})">${esc(ev.title)}</div>`;
        });
        html += '</div>';
      });
      html += '</div>';
      el.innerHTML = html;
    }

    function renderAgenda() {
      const el = document.getElementById('cal-view');
      // Group by day
      const grouped = {};
      filteredEvents().forEach(ev => {
        const dk = dayKey(new Date(ev.start));
        (grouped[dk] = grouped[dk] || []).push(ev);
      });
      const sortedDays = Object.keys(grouped).sort();
      if (!sortedDays.length) { el.innerHTML = '<div style="text-align:center;padding:3rem;color:#8b949e">No upcoming events</div>'; return; }

      let html = '';
      sortedDays.forEach(dk => {
        const d = new Date(dk + 'T12:00:00');
        const isT = dk === todayStr;
        const label = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        html += `<div class="agenda-group"><div class="agenda-date${isT ? ' today' : ''}">${isT ? 'üìç Today ‚Äî ' : ''}${label}</div>`;
        grouped[dk].forEach(ev => {
          const timeStr = ev.allDay ? 'All day' : new Date(ev.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + ' ‚Äì ' + new Date(ev.end).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          html += `<div class="agenda-item" onclick="showPopover(event, ${JSON.stringify(ev).replace(/"/g, '&quot;')})">
            <div class="agenda-dot" style="background:${ev.color}"></div>
            <div class="agenda-time">${timeStr}</div>
            <div class="agenda-title">${esc(ev.title)}</div>
          </div>`;
        });
        html += '</div>';
      });
      el.innerHTML = html;
    }

    // --- Navigation ---
    document.getElementById('btn-prev').onclick = () => { navigate(-1); };
    document.getElementById('btn-next').onclick = () => { navigate(1); };
    document.getElementById('btn-today').onclick = () => { viewDate = new Date(); loadEvents(); };

    function navigate(dir) {
      if (currentView === 'month') viewDate.setMonth(viewDate.getMonth() + dir);
      else if (currentView === 'week') viewDate.setDate(viewDate.getDate() + 7 * dir);
      else viewDate.setDate(viewDate.getDate() + 14 * dir);
      loadEvents();
    }

    document.querySelectorAll('.view-btn').forEach(b => {
      b.onclick = () => {
        document.querySelectorAll('.view-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        currentView = b.dataset.view;
        loadEvents();
      };
    });

    // --- Sources ---
    function openAddSource() {
      document.getElementById('modal-title').textContent = 'Add Source';
      document.getElementById('src-edit-id').value = '';
      document.getElementById('src-name').value = '';
      document.getElementById('src-type').value = 'ical';
      document.getElementById('src-url').value = '';
      document.getElementById('src-color').value = '#58a6ff';
      document.getElementById('modal-delete').style.display = 'none';
      toggleUrlField();
      document.getElementById('source-modal').classList.add('open');
    }

    function editSource(id) {
      const s = sources.find(x => x.id === id);
      if (!s) return;
      document.getElementById('modal-title').textContent = 'Edit Source';
      document.getElementById('src-edit-id').value = id;
      document.getElementById('src-name').value = s.name;
      document.getElementById('src-type').value = s.type;
      document.getElementById('src-url').value = s.url || '';
      document.getElementById('src-color').value = s.color;
      document.getElementById('modal-delete').style.display = 'block';
      toggleUrlField();
      document.getElementById('source-modal').classList.add('open');
    }

    document.getElementById('src-type').onchange = toggleUrlField;
    function toggleUrlField() {
      const isCron = document.getElementById('src-type').value === 'cron';
      document.getElementById('lbl-url').style.display = isCron ? 'none' : 'block';
      document.getElementById('src-url').style.display = isCron ? 'none' : 'block';
    }

    function closeModal() { document.getElementById('source-modal').classList.remove('open'); }

    async function saveSource() {
      const id = document.getElementById('src-edit-id').value;
      const body = {
        name: document.getElementById('src-name').value || 'Untitled',
        type: document.getElementById('src-type').value,
        url: document.getElementById('src-url').value,
        color: document.getElementById('src-color').value,
        enabled: true
      };
      if (id) await api('PATCH', `/sources/${id}`, body);
      else await api('POST', '/sources', body);
      closeModal();
      sources = await api('GET', '/sources');
      loadEvents();
    }

    async function deleteSource() {
      const id = document.getElementById('src-edit-id').value;
      if (!id) return;
      await api('DELETE', `/sources/${id}`);
      closeModal();
      sources = await api('GET', '/sources');
      loadEvents();
    }

    async function toggleSource(id, enabled) {
      await api('PATCH', `/sources/${id}`, { enabled });
      const s = sources.find(x => x.id === id);
      if (s) s.enabled = enabled;
      loadEvents();
    }

    // --- Popover ---
    function showPopover(e, ev) {
      e.stopPropagation();
      const pop = document.getElementById('popover');
      document.getElementById('pop-title').textContent = ev.title;
      const st = new Date(ev.start);
      const en = new Date(ev.end);
      document.getElementById('pop-time').textContent = ev.allDay ? 'All day' :
        st.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' ¬∑ ' +
        st.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + ' ‚Äì ' +
        en.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      document.getElementById('pop-source').textContent = 'üìÅ ' + (ev.source || '');
      document.getElementById('pop-location').textContent = ev.location ? 'üìç ' + ev.location : '';
      document.getElementById('pop-desc').textContent = ev.description || '';
      document.getElementById('pop-desc').style.display = ev.description ? 'block' : 'none';

      const rect = (e.target.closest('.ev-chip,.week-event,.agenda-item') || e.target).getBoundingClientRect();
      pop.style.top = Math.min(rect.bottom + 8, window.innerHeight - 250) + 'px';
      pop.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
      pop.classList.add('open');
    }

    function closePopover() { document.getElementById('popover').classList.remove('open'); }
    document.addEventListener('click', (e) => {
      if (!document.getElementById('popover').contains(e.target)) closePopover();
    });

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    init();
  </script>
</body>
</html>
